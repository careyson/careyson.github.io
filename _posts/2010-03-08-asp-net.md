---
layout: post
title: "Asp.net缓存简介"
date: 2010-03-08
categories: blog
tags: [博客园迁移]
---

## ****

## **概述**

缓存学术一些的解释是”将常用数据放入易于读取的地方以提高性能”。而对于Asp.net来说，需要被缓存的对象多种多样，包括从数据库中提取出来的数据，以及aspx页面生成的静态页，甚至是编译好的程序集。合理利用缓存能让Asp.net的性能大幅提升，下面将对Asp.net中的缓存机制进行简单概述。

## **缓存的分类**

在Asp.net中，大部分缓存机制是保存在cache对象中，也就是服务器内存的一部分。当用户请求数据时，如果数据已经被缓存，则用户所提取的数据直接从服务端返回，而不是从数据库等底层数据库提取。这对性能的提升不得不说很有帮助。下面来看asp.net中几种缓存机制。

### **程序集缓存**

简单的说，这种缓存是asp.net自带的，无需开发人员进行参与的缓存方式。即当第一次请求服务器时，Page类以及相关程序集被编译，当下次请求时，访问缓存后的编译而不是重新编译。CLR会自动检测代码的改变，如果代码改变后，当下次访问时，相关代码会被重新编译。

### **数据源缓存**

数据源缓存，顾名思义，也就是利用数据源控件对获取的数据进行缓存的方式。这些控件包括SqlDataSource,ObjectDataSource等：

[![image](https://cdn.jsdelivr.net/gh/careyson/careyson.github.io@main/assets/images/2010-03-08-asp-net/asp-net-datasource_thumb.png)](http://images.cnblogs.com/cnblogs_com/CareySon/WindowsLiveWriter/Asp.net_11E9A/datasource_2.png)

作为抽象类的DataSourceControl暴漏了如下属性用于缓存：

名称 | 说明  
---|---  
[CacheDuration](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.cacheduration.aspx) | 获取或设置以秒为单位的一段时间，数据源控件就在这段时间内缓存 [SelectMethod](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.selectmethod.aspx) 属性检索到的数据。  
[CacheExpirationPolicy](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.cacheexpirationpolicy.aspx) | 获取或设置缓存的到期行为，该行为与持续时间组合在一起可以描述数据源控件所用缓存的行为。  
[CacheKeyDependency](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.cachekeydependency.aspx) | 获取或设置一个用户定义的键依赖项，该键依赖项链接到数据源控件创建的所有数据缓存对象。  
[EnableCaching](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.enablecaching.aspx) | 获取或设置一个值，该值指示 [ObjectDataSource](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.aspx) 控件是否启用数据缓存。  
  
而使用起来就非常简单了，只需要将缓存的相关属性进行设置即可。比如我想要当前数据源缓存10秒，只需要设置EnableCaching属性和CacheDuration属性如下：
    
    
    <asp:SqlDataSource ID="SqlDataSource1" runat="server" 
                ConnectionString="<%$ ConnectionStrings:AdventureWorksConnectionString %>" 
                SelectCommand="SELECT top 10 * FROM [Person].[Contact]" **EnableCaching ="true" CacheDuration="10"></**asp:SqlDataSource>

这种方式的工作原理可以用下图表示：

[![image](https://cdn.jsdelivr.net/gh/careyson/careyson.github.io@main/assets/images/2010-03-08-asp-net/asp-net-3_thumb.png)](http://images.cnblogs.com/cnblogs_com/CareySon/WindowsLiveWriter/Asp.net_11E9A/3_2.png)

关于ObjectDataSource我推荐阅读[Caching Data with the ObjectDataSource](http://www.asp.net/learn/data-access/tutorial-58-cs.aspx)

#### **SQL Cache Dependency**

大家应该注意到了上面的数据源控件还暴漏了[CacheKeyDependency](http://msdn.microsoft.com/zh-cn/library/system.web.ui.webcontrols.objectdatasource.cachekeydependency.aspx)属性，这是用于实现SQL Cache Dependency的方式，关于Dependency,其实就是在数据库表内容改变时，将相应的缓存进行更新，正如Dependency这个词的意思一样，是缓存依赖底层数据库。下面就要说到两种实现SQL Cache Dependency的方法了。

**方法一：使用轮流查询机制（polling-based）：**

**** 这种方式实现机制是在sql server中插入以AspNet\_SqlCacheNotification\_Trigger开头的一个特殊的表和5个存储过程，当被监测的表数据发生改变时，则一个名为AspNet\_SqlCacheTablesForChangeNotification的表被更新，而Asp.net程序会根据用户设置的间隔时间每隔一定时间检查一下数据库内容是否更新，如果更新，则将缓存中的数据进行跟新。

这种机制配置相对比较麻烦。具体做法网上有很多教程，这里我推荐阅读:[Using SQL Cache Dependencies](http://www.asp.net/learn/data-access/tutorial-61-cs.aspx).

使用起来就很简单了，可以在页面头部的OutputCache指令中设置，会社DataSource空间中进行设置，设置格式为：“数据库名：表名”.里面的表名即是需要监测是否改变的表名，示例如下：
    
    
    <%@ OutputCache Duration="30" VaryByParam="none" SqlDependency="DatabaseName:tableName" %> 

如果需要添加多个表，则用”;”进行分割
    
    
    SqlDependency="database:table;database:table"

**方法二：使用通知机制\(notification-based\)**

****

**** 使用通知机制配置起来要简便很多，但是sql server的版本需要9.0以上，也就是sql server 2005,使用这种方式需要将sql server的通知服务开启。

使用通知机制可以对页面进行缓存，也可以对datasouce控件进行缓存，对页面进行缓存代码如下：
    
    
    <%@ OutputCache Duration="30" VaryByParam="none" SqlDependency="CommandNotification" %>

注意SqlDependency必须设置成CommandNotification。

对于datasource控件，也是同样：
    
    
            <asp:SqlDataSource ID="SqlDataSource1" runat="server" 
                ConnectionString="<%$ ConnectionStrings:AdventureWorksConnectionString %>" 
                SelectCommand="SELECT top 10 * FROM [Person].[Contact]" EnableCaching="true" CacheDuration="10" SqlCacheDependency="CommandNotification"></asp:SqlDataSource>

### **输出缓存（output Caching）**

输出缓存是页面级别的缓存，是将aspx页面内容在第一次请求后生成的静态页放入缓存，在不过期时间内每一次请求时从缓存中返回静态页，而不是重新走完Asp.net的生命周期。可以将可以通过在页面头部加入OutputCache指令实现，也可以通过HttpCachePolicy类实现。

输出缓存可以缓存整个页面，也可以缓存部分页面，缓存页面的一部分是通过用户控件来实现。

下面来看通过OutputCache指令实现页面缓存:

前面已经看到，这种方式十分简单，下面说一下OutputCache的重点属性

**Duration**

页面过期的时间，单位为秒。超过过期时间后，则在下一次请求时页面会重新生成并缓存。

**VaryByHeader**

**VaryByCustom**

**VaryByParam**

**VaryByControl**

**VaryByContentEncodings**

**** 这些属性都是为了保存页面的多个版本，比如说一个页面用于显示产品，则根据产品id的不同，缓存同一个页面的不同版本，具体的意思请看[MSDN](http://msdn.microsoft.com/zh-cn/library/hdxfb6cy.aspx)

**CacheProfile**

**** 这个选项有些像连接字符串,作用只是将具体的缓存选项变成对于选项的引用，比如我们在Web.Config放入如下代码：
    
    
    <caching>
            <outputCacheSettings>
              <outputCacheProfiles>
                <add name="CacheProfile"
                      enabled="true"
                      duration="60"
                       varyByParam="product:id"/>
              </outputCacheProfiles>
            </outputCacheSettings>
                
           
          </caching>

则在引用时只需要在页面头部设置如下:
    
    
    <%@ OutputCache CacheProfile="CacheProfile" %>

而不是全部写入页面

**DiskCacheable**

因为服务器内存是有限的，所以通过将DiskCacheable属性设置为true，则可以将缓存页面放入硬盘中，这样即使服务器崩溃重启，缓存依然存在.

#### **缓存部分页面**

缓存页面的一部分实现原理和缓存整个页面毫无二致，都是在页面头部加入OutputCache指令，唯一的不同是缓存部分页面是在用户控件中进行的。这部分就不在多说了。

#### **使用HttpCachePolicy缓存页面**

前面已经说了通过OutputCache指令在页面头部设置缓存选项，另一种替代方法是使用HttpCachePolicy类，这个类的实例是Response.Cache.如果使用HttpCachePolicy设置缓存，则需要在页面移除OutputCache指令。

比如:
    
    
    <%@ OutputCache  Duration="30" VaryByParam="state;city" %>

和下面代码是等价的：
    
    
     	Response.Cache.SetExpires(DateTime.Now.AddSeconds(30));
          Response.Cache.VaryByParams["state"] = true;
          Response.Cache.VaryByParams["city"] = true;

更多关于HttpCachePolicy，请查看[MSDN](http://msdn.microsoft.com/zh-cn/vstudio/system.web.httpcachepolicy.aspx)

### **对象缓存**

对象缓存是将继承与System.Object的对象缓存在服务器的内存中，通过Page类的Cache属性可以访问到Cache集合。Cache内可以放任何类型的对象，但是要小心使用Cache,因为Cache是占用服务器内存，如果使用不当，也许会拖累性能。

使用Cache的例子：
    
    
            //save object into Cache
            Cache["table"] = GridView1;
    
            //get object from Cache
            GridView gv = (GridView)Cache["table"];

要注意的是，再提取缓存中的对象时，一定别忘了强制转换。

## **总结**

文中对Asp.net的缓存机制进行了简述，asp.net中的缓存极大的简化了开发人员的使用。如果使用得当，程序性能会有客观的提升。
