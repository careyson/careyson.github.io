---
layout: post
title: "【译】使用C# yield关键字来提高性能和可读性"
date: 2009-12-16
categories: blog
tags: [博客园迁移]
---

对于”yield”这个关键字我已经见过N次了，直到最近我才知道这个关键字所蕴含的力量。我将在下面展示出一些使用”yield”让你的代码有更高可读性和更好性能的例子.

为了让你对yield有一些快速概览,我首先要展示一个没有使用这个关键字的例子,下面的代码很简单，但在我最近的项目中却很常见
    
    
    IList<string> FindBobs(IEnumerable<string> names)
    {
    	var bobs = new List<string>();
    
    	foreach(var currName in names)
    	{
    		if(currName == "Bob")
    			bobs.Add(currName);
    	}
    
    	return bobs;
    }

注意在这里我使用IEnumerable<string>作为参数类型并以IList<string>作为返回类型，通常来说，我更倾向于在参数输入的类型方面的范围越宽越好，但在返回类型上面更加严格（译者按：即输入时多用基类或接口，返回时用子类或实现类），对于输入来说，如果你需要用foreach来对其进行循环的话，使用IEnumerable会更有意义。而对于输出（译者按：也就是返回），我使用接口来让实现部分可以改变。在这里我想让调用者省去生成列表的麻烦，所以我选择list作为返回类型.

而问题在于，我的设计并不具有可链接性，这样的设计需要产生列表作为返回值，实现上，这个列表或许不会很大，但这并不必要

****

现在,让我们来看看以“yield”的方式来做这些，而后我会解释如何使用它，以及它工作的原理。
    
    
    IEnumerable<string> FindBobs(IEnumerable<string> names)
    {
    	foreach(var currName in names)
    	{
    		if(currName == "Bob")
    			yield return currName;
    	}
    }

在这个版本中，我们将返回类型改为IEnumerable，并且我们使用”yield return”.注意我再也不需要创建一个列表，现在是不是有些迷惑的？别着急，在理解它的工作方式的情况它会变的越来越简单.

当使用”yield return”关键词组时，.net会为你生成一大串管道代码，你可以尽管假装这是个魔法。当开始在被调用的代码中循环时（这里不是list\),实现上发生的是这个函数被一遍一遍的调用，但每一次都从上一次执行退出的部分开始继续执行.

#### **传统的执行方法**

  1. 调用函数
  2. 函数执行并返回list
  3. 调用部分使用返回的list



#### **Yield的执行方法**

  1. 调用函数
  2. 调用者请求item
  3. 下一个item返回
  4. 回到步骤2



虽然yield执行的实现貌似有些复杂，但我们最终只需要一次“弹出”一个item，而不是创建整个list并返回.

对于句法说，我个人认为yield更加简洁，并且对于传递函数的用途表现的更好（译者按：也就是代码可读性）,我使用IEnumerable作为返回类型来通知调用者它可以被foreach循环并且返回数据，**而调用者现在可以自己决定** 它是否愿意将返回值存放到列表中，即使这会以性能作为代价。

在我提供的这个简单例子中，也许你并不能发现很多使用yield的好处，然而，你可以在调用者需要取消遍历所有的函数提供的内容时节省很多不必要的工作，当你在方法链接时使用yield，你可以省下的工作\(时间）或许会成倍叠加。

Ayende已经有了很棒的例子:[using yield for a slick pipes & filters implementation](http://ayende.com/Blog/archive/2008/01/05/Pipes-and-filters-The-IEnumerable-appraoch.aspx),他甚至还讲述了：[version that is multi-threaded](http://ayende.com/Blog/archive/2008/01/06/Pipes-and-filters-The-multi-threaded-version.aspx)。这让我觉得非常有趣.

最开始我对yield的保留意见是使用这个关键字或许会导致潜在的性能问题，但实际上，至今为止我还未能发现任何信息来说明关于yield对性能的影响,而我在上面提到提高性能的地方远远大于编译器overhead那部分。

## **小结**

Yield可以让你的代码更加高效并拥有更高的可读性，已经是.net 2.0时代了，我想已经没有什么借口可以阻止我们学习和使用yield.

\---------------------------------------------------------------------

译者:这篇文章是我翻译的十个鲜为人知的C\#关键字里的[pangxiaoliang\[北京\]流浪者](http://www.cnblogs.com/pangxiaoliang/)同学在评论中提出的意见，那篇文章只是做了个总结，我发现已经有关于论述更深层次的好文了，所以我就不重复发明轮子直接进行翻译了，在翻译的过程中我也学到了不少.谢谢

原文链接:<http://www.ytechie.com/2009/02/using-c-yield-for-readability-and-performance.html>
